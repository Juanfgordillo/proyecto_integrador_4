<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - FoodGo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { 
      background: linear-gradient(135deg, #28a745, #20c997);
      height: 100vh; 
      display: flex; 
      align-items: center; 
      justify-content: center;
    }
    .login-box { 
      background: white; 
      padding: 2rem; 
      border-radius: 15px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
      max-width: 400px; 
      width: 100%; 
    }
    .error-message {
      color: red;
      font-size: 0.9rem;
      margin-bottom: 10px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="login-box">
    <h2 class="text-center mb-4">üçî FoodGo</h2>
    <p class="text-center text-muted mb-2">Sistema de Pedidos</p>
    
    <div class="error-message" id="errorMsg"></div>
    
    <form id="loginForm">
      <div class="mb-3">
        <label class="form-label fw-semibold">üìù C√©dula</label>
        <input type="text" class="form-control" id="id_usuario" required placeholder="Ingresa tu c√©dula">
      </div>
      <div class="mb-4">
        <label class="form-label fw-semibold">üîí Contrase√±a</label>
        <input type="password" class="form-control" id="password" required placeholder="Ingresa tu contrase√±a">
      </div>
      <button type="submit" class="btn btn-success w-100 py-2 fw-semibold">
        üöÄ Ingresar al Sistema
      </button>
    </form>

    <div class="text-center mt-3">
      <small class="text-muted">¬øNo tienes cuenta? 
        <a href="registro.html" class="text-success">Reg√≠strate aqu√≠</a>
      </small>
    </div>
  </div>

  <script>
  const loginForm = document.getElementById('loginForm');
  const btn = loginForm.querySelector('button');
  const errorMsg = document.getElementById('errorMsg');

  loginForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    errorMsg.style.display = 'none';

    const originalText = btn.textContent;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Verificando...';

    const payload = {
      id_usuario: document.getElementById('id_usuario').value.trim(),
      password: document.getElementById('password').value
    };

    try {
      const res = await fetch("http://localhost:3000/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(payload)
      });

      if (!res.ok) throw new Error("Respuesta inv√°lida del servidor");

      const result = await res.json();

      btn.disabled = false;
      btn.textContent = originalText;

      if (result.success && result.user && result.user.rol) {
        localStorage.setItem("rol", result.user.rol);
        localStorage.setItem("cedula", result.user.cedula);

        switch(result.user.rol) {
          case "cliente":
            window.location.href = "index.html";
            break;
          case "repartidor":
            window.location.href = "repartidor.html";
            break;
          case "admin":
            window.location.href = "admin.html";
            break;
          default:
            errorMsg.textContent = "‚ùå Rol no reconocido";
            errorMsg.style.display = "block";
        }
      } else {
        errorMsg.textContent = "‚ùå Credenciales inv√°lidas";
        errorMsg.style.display = "block";
      }

    } catch (err) {
      console.error("Error al conectar con /login:", err);
      errorMsg.textContent = "‚ùå Error al conectar con el servidor";
      errorMsg.style.display = "block";
      btn.disabled = false;
      btn.textContent = originalText;
    }
  });

  
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("id_usuario").focus();
  });
  fetch("/login", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  credentials: "include",  
  body: JSON.stringify({ id_usuario, password })
})
.then(res => res.json())
.then(result => {
  if (result.success && result.user) {
    
    switch(result.user.rol) {
      case "cliente":
        window.location.href = "/cliente";
        break;
      case "repartidor":
        window.location.href = "/repartidor";
        break;
      case "admin":
        window.location.href = "/admin";
        break;
      default:
        alert("Rol no reconocido");
    }
  } else {
    alert(result.error || "Credenciales incorrectas");
  }
});

</script>
</body>
</html>
